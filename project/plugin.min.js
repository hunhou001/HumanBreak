var CorePlugin=function(exports){"use strict";function createCanvas(e,t){if(e){var r=document.createElement("canvas");r.id=e,r.className="gameCanvas no-anti-aliasing","editor"!=main.mode&&(r.style.zIndex=t||0),document.getElementById("gameDraw").appendChild(r);var o=r.getContext("2d");return core.canvas[e]=o,r}}var bg2Canvas=createCanvas("bg2",20),fg2Canvas=createCanvas("fg2",63);if(core.bigmap.canvas=["bg2","fg2","bg","event","event2","fg","damage"],core.initStatus.bg2maps={},core.initStatus.fg2maps={},"editor"==main.mode){document.getElementById("mapEdit").insertBefore(bg2Canvas,document.getElementById("event")),document.getElementById("mapEdit").insertBefore(fg2Canvas,document.getElementById("ebm"));var num=4;editor.dom.bg2c=core.canvas.bg2.canvas,editor.dom.bg2Ctx=core.canvas.bg2,editor.dom.fg2c=core.canvas.fg2.canvas,editor.dom.fg2Ctx=core.canvas.fg2,editor.dom.maps.push("bg2map","fg2map"),editor.dom.canvas.push("bg2","fg2");var createCanvasBtn=function(e){var t=document.createElement("input"),r="layerMod"+num++,o=e+"map";return t.type="radio",t.name="layerMod",t.id=r,t.value=o,editor.dom[r]=t,t.onchange=function(){editor.uifunctions.setLayerMod(o)},t},createCanvasBtn_mobile=function(e){var t=document.createElement("option"),r="layerMod"+num++,o=e+"map";return t.name="layerMod",t.value=o,editor.dom[r]=t,t};if(editor.isMobile){var input=createCanvasBtn_mobile("bg2"),input2=createCanvasBtn_mobile("fg2");input.innerText="背景2",input2.innerText="前景2";var parent=document.getElementById("layerMod");parent.insertBefore(input,parent.children[1]),parent.appendChild(input2)}else{var input=createCanvasBtn("bg2"),input2=createCanvasBtn("fg2"),child=document.getElementById("layerMod"),parent=child.parentNode;parent.insertBefore(input,child);var txt=document.createTextNode("背2");parent.insertBefore(txt,child),parent.appendChild(input2);var txt2=document.createTextNode("前2");parent.appendChild(txt2)}}core.maps._loadFloor_doNotCopy=function(){return["firstArrive","eachArrive","blocks","parallelDo","map","bgmap","fgmap","bg2map","fg2map","events","changeFloor","afterBattle","afterGetItem","afterOpenDoor","cannotMove"]},core.maps._drawBg_draw=function(e,t,r,o){o.ctx=r,core.maps._drawBg_drawBackground(e,o),core.maps._drawFloorImages(e,o.ctx,"bg",null,null,o.onMap),core.maps._drawBgFgMap(e,"bg",o),o.onMap&&(core.drawImage(t,r.canvas,core.bigmap.v2?-32:0,core.bigmap.v2?-32:0),core.clearMap("bg2"),core.clearMap(r)),core.maps._drawBgFgMap(e,"bg2",o),o.onMap&&core.drawImage("bg2",r.canvas,core.bigmap.v2?-32:0,core.bigmap.v2?-32:0),o.ctx=t},core.maps._drawFg_draw=function(e,t,r,o){o.ctx=r,core.maps._drawFloorImages(e,o.ctx,"fg",null,null,o.onMap),core.maps._drawBgFgMap(e,"fg",o),o.onMap&&(core.drawImage(t,r.canvas,core.bigmap.v2?-32:0,core.bigmap.v2?-32:0),core.clearMap("fg2"),core.clearMap(r)),core.maps._drawBgFgMap(e,"fg2",o),o.onMap&&core.drawImage("fg2",r.canvas,core.bigmap.v2?-32:0,core.bigmap.v2?-32:0),o.ctx=t},core.maps._generateMovableArray_arrays=function(e){return{bgArray:this.getBgMapArray(e),fgArray:this.getFgMapArray(e),eventArray:this.getMapArray(e),bg2Array:this._getBgFgMapArray("bg2",e),fg2Array:this._getBgFgMapArray("fg2",e)}},["up","down","left","right"].forEach((function(e){core.material.icons.hero[e].midFoot=2}));var heroMoving=function(e){core.status.heroMoving<=0||(e-core.animateFrame.moveTime>core.values.moveSpeed&&(core.animateFrame.leftLeg++,core.animateFrame.moveTime=e),core.drawHero(["stop","leftFoot","midFoot","rightFoot"][core.animateFrame.leftLeg%4],4*core.status.heroMoving))};function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var o,a,n,c,s=[],l=!0,i=!1;try{if(n=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(o=n.call(r)).done)&&(s.push(o.value),s.length!==t);l=!0);}catch(e){i=!0,a=e}finally{try{if(!l&&null!=r.return&&(c=r.return(),Object(c)!==c))return}finally{if(i)throw a}}return s}}function _regeneratorRuntime(){_regeneratorRuntime=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},n=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function i(e,t,r,a){var n=t&&t.prototype instanceof f?t:f,c=Object.create(n.prototype),s=new x(a||[]);return o(c,"_invoke",{value:k(e,r,s)}),c}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=i;var d={};function f(){}function p(){}function h(){}var m={};l(m,n,(function(){return this}));var g=Object.getPrototypeOf,v=g&&g(g(I([])));v&&v!==t&&r.call(v,n)&&(m=v);var y=h.prototype=f.prototype=Object.create(m);function b(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function a(o,n,c,s){var l=u(e[o],e,n);if("throw"!==l.type){var i=l.arg,d=i.value;return d&&"object"==typeof d&&r.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,c,s)}),(function(e){a("throw",e,c,s)})):t.resolve(d).then((function(e){i.value=e,c(i)}),(function(e){return a("throw",e,c,s)}))}s(l.arg)}var n;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){a(e,r,t,o)}))}return n=n?n.then(o,o):o()}})}function k(e,t,r){var o="suspendedStart";return function(a,n){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===a)throw n;return B()}for(r.method=a,r.arg=n;;){var c=r.delegate;if(c){var s=w(c,r);if(s){if(s===d)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===o)throw o="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o="executing";var l=u(e,t,r);if("normal"===l.type){if(o=r.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o="completed",r.method="throw",r.arg=l.arg)}}}function w(e,t){var r=t.method,o=e.iterator[r];if(void 0===o)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var a=u(o,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var n=a.arg;return n?n.done?(t[e.resultName]=n.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):n:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function M(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function I(e){if(e){var t=e[n];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,a=function t(){for(;++o<e.length;)if(r.call(e,o))return t.value=e[o],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:B}}function B(){return{value:void 0,done:!0}}return p.prototype=h,o(y,"constructor",{value:h,configurable:!0}),o(h,"constructor",{value:p,configurable:!0}),p.displayName=l(h,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,l(e,s,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},b(_.prototype),l(_.prototype,c,(function(){return this})),e.AsyncIterator=_,e.async=function(t,r,o,a,n){void 0===n&&(n=Promise);var c=new _(i(t,r,o,a),n);return e.isGeneratorFunction(r)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},b(y),l(y,s,"Generator"),l(y,n,(function(){return this})),l(y,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var o in t)r.push(o);return r.reverse(),function e(){for(;r.length;){var o=r.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},e.values=I,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(M),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function o(r,o){return c.type="throw",c.arg=e,t.next=r,o&&(t.method="next",t.arg=void 0),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var n=this.tryEntries[a],c=n.completion;if("root"===n.tryLoc)return o("end");if(n.tryLoc<=this.prev){var s=r.call(n,"catchLoc"),l=r.call(n,"finallyLoc");if(s&&l){if(this.prev<n.catchLoc)return o(n.catchLoc,!0);if(this.prev<n.finallyLoc)return o(n.finallyLoc)}else if(s){if(this.prev<n.catchLoc)return o(n.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return o(n.finallyLoc)}}}},abrupt:function(e,t){for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var n=a;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var c=n?n.completion:{};return c.type=e,c.arg=t,n?(this.method="next",this.next=n.finallyLoc,d):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),M(r),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var o=r.completion;if("throw"===o.type){var a=o.arg;M(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:I(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),d}},e}function asyncGeneratorStep(e,t,r,o,a,n,c){try{var s=e[n](c),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(o,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(o,a){var n=e.apply(t,r);function c(e){asyncGeneratorStep(n,o,a,c,s,"next",e)}function s(e){asyncGeneratorStep(n,o,a,c,s,"throw",e)}c(void 0)}))}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var o=0,a=function(){};return{s:a,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,c=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return c=e.done,e},e:function(e){s=!0,n=e},f:function(){try{c||null==r.return||r.return()}finally{if(s)throw n}}}}function getItemDetail(floorId,onMap){var _floorId;if(core.getFlag("itemDetail")){null!==(_floorId=floorId)&&void 0!==_floorId||(floorId=core.status.thisMap.floorId);var diff={},before=core.status.hero,hero=core.clone(core.status.hero),handler={set:function(e,t,r){return diff[t]=r-(e[t]||0),diff[t]||(diff[t]=void 0),!0}};core.status.hero=new Proxy(hero,handler),core.status.maps[floorId].blocks.forEach((function(block){if("items"===block.event.cls&&!block.disable){var x=block.x,y=block.y;if(!(onMap&&core.bigmap.v2&&(x<core.bigmap.posX-core.bigmap.extend||x>core.bigmap.posX+core._PX_+core.bigmap.extend||y<core.bigmap.posY-core.bigmap.extend||y>core.bigmap.posY+core._PY_+core.bigmap.extend))){diff={};var id=block.event.id,item=core.material.items[id];if("equips"!==item.cls){core.setFlag("__statistics__",!0);try{eval(item.itemEffect)}catch(e){}drawItemDetail(diff,x,y)}else{var _item$equip$value,_item$equip$percentag,_diff=core.clone(null!==(_item$equip$value=item.equip.value)&&void 0!==_item$equip$value?_item$equip$value:{}),per=null!==(_item$equip$percentag=item.equip.percentage)&&void 0!==_item$equip$percentag?_item$equip$percentag:{};for(var name in per)_diff[name+"per"]=per[name].toString()+"%";drawItemDetail(_diff,x,y)}}}})),core.status.hero=before,window.hero=before,window.flags=before.flags}}function drawItemDetail(e,t,r){var o=32*t+2,a=32*r+31,n="",c=0;for(var s in e)if(e[s]){var l="#fff";switch(n="number"==typeof e[s]?core.formatBigNumber(e[s],!0):e[s],s){case"atk":case"atkper":l="#FF7A7A";break;case"def":case"defper":l="#00E6F1";break;case"mdef":case"mdefper":l="#6EFF83";break;case"hp":l="#A4FF00";break;case"hpmax":case"hpmaxper":l="#F9FF00";break;case"mana":l="#c66"}core.status.damage.data.push({text:n,px:o,py:a-10*c,color:l}),c++}}function checkMockery(e,t){if(!core.status.lockControl||t){var r=core.status.checkBlock.mockery[e];if(r){r.sort((function(e,t){return e[0]===t[0]?e[1]-t[1]:e[0]-t[0]}));var o=[],a=_slicedToArray(r[0],2),n=a[0],c=a[1],s=core.status.hero.loc,l=s.x,i=s.y,u=l>n?"left":l<n?"right":i>c?"up":"down",d=core.utils.scan[u],f=d.x,p=d.y;o.push({type:"changePos",direction:u});for(var h=core.getMapBlocksObj();;){i+=p;var m=h["".concat(l+=f,",").concat(i)];if(m&&(m.event.cls,["animates","autotile","tileset","npcs","npc48","terrains"].includes(m.event.cls)&&o.push({type:"hide",loc:[[l,i]],remove:!0,time:0},{type:"function",function:"function() { core.removeGlobalAnimate(".concat(l,", ").concat(i,") }")},{type:"animate",name:"hand",loc:[l,i],async:!0}),m.event.cls.startsWith("enemy")&&o.push({type:"moveAction"})),o.push({type:"moveAction"}),l===n&&i===c)break}o.push({type:"function",function:"function() { core.checkBlock(true); }"}),o.push({type:"stopAsync"}),core.insertAction(o)}}}core.registerAnimationFrame("heroMoving",!0,heroMoving),core.events._eventMoveHero_moving=function(e,t){var r=t[0],o=r[0],a=core.getHeroLoc("x"),n=core.getHeroLoc("y"),c="backward"==o?-1:1;"forward"!=o&&"backward"!=o||(o=core.getHeroLoc("direction"));var s=o;return"leftup"!=o&&"leftdown"!=o||(s="left"),"rightup"!=o&&"rightdown"!=o||(s="right"),core.setHeroLoc("direction",o),r[1]<=0?(core.setHeroLoc("direction",s),t.shift(),!0):(e<=4?core.drawHero("stop",4*c*e):e<=8?core.drawHero("leftFoot",4*c*e):e<=12?core.drawHero("midFoot",4*c*(e-8)):e<=16&&core.drawHero("rightFoot",4*c*(e-8)),(8==e||16==e)&&(core.setHeroLoc("x",a+c*core.utils.scan2[o].x,!0),core.setHeroLoc("y",n+c*core.utils.scan2[o].y,!0),core.updateFollowers(),r[1]--,r[1]<=0&&t.shift(),core.setHeroLoc("direction",s),16==e))},function(){if("play"===main.mode&&!main.replayChecking){var e=new WebSocket("ws://127.0.0.1:8080");e.addEventListener("open",(function(){console.log("Web socket connect successfully")})),e.addEventListener("message",(function(e){var a=JSON.parse(e.data);"reload"===a.type&&location.reload(),"floorHotReload"===a.type&&function(e){t.apply(this,arguments)}(a.floor),"dataHotReload"===a.type&&function(e){o.apply(this,arguments)}(a.data),"functionsHotReload"===a.type&&function(){r.apply(this,arguments)}(),"cssHotReload"===a.type&&function(e){document.getElementById("mota-css").remove();var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.id="mota-css",document.head.appendChild(t),console.log("Css hot reload: ".concat(e))}(a.path)}))}function t(){return(t=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!core.status.maps||!core.status.maps[t].deleted&&!core.status.maps[t].forceDelete){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,import("/forceTem/project/floors/".concat(t,".js?v=").concat(Date.now()));case 4:core.floors[t]=main.floors[t],r=core.loadFloor(t),core.isPlaying()&&(core.status.maps[t]=r,delete core.status.mapBlockObjs[t],core.extractBlocks(t),t===core.status.floorId&&(core.drawMap(t),!(o=core.getFlag("__weather__",null))&&core.status.thisMap.weather&&(o=core.status.thisMap.weather),o?core.setWeather(o[0],o[1]):core.setWeather()),core.updateStatusBar(!0,!0)),console.log("Floor hot reload: ".concat(t));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function r(){return(r=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,r,o,a,n,c,s,l;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a,(r=document.createElement("script")).src="/forceTem/project/functions.js?v=".concat(Date.now()),document.body.appendChild(r),e.next=6,new Promise((function(e){r.onload=function(){return e("success")}}));case 6:o=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a,e.t0=_regeneratorRuntime().keys(t);case 8:if((e.t1=e.t0()).done){e.next=23;break}a=e.t1.value,n=t[a],e.t2=_regeneratorRuntime().keys(n);case 12:if((e.t3=e.t2()).done){e.next=21;break}if(c=e.t3.value,"function"==typeof(s=n[c])&&"hasSpecial"!==c){e.next=17;break}return e.abrupt("continue",12);case 17:if(l=o[a][c],s.toString()!==l.toString())try{"events"===a?core.events.eventdata[c]=l:"enemys"===a?core.enemys.enemydata[c]=l:"actions"===a?core.actions.actionsdata[c]=l:"control"===a?core.control.controldata[c]=l:"ui"===a&&(core.ui.uidata[c]=l),core.updateStatusBar(!0,!0),console.log("Function hot reload: ".concat(a,".").concat(c))}catch(e){console.error(e)}e.next=12;break;case 21:e.next=8;break;case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function o(){return(o=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,o,a,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=document.createElement("script")).src="/forceTem/project/".concat(t,".js?v=").concat(Date.now()),document.body.appendChild(r),e.next=5,new Promise((function(e){r.onload=function(){return e("success")}}));case 5:if("data"===t&&(o=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d),"enemys"===t&&(o=enemys_fcae963b_31c9_42b4_b48c_bb48d09f3f80),"icons"===t&&(o=icons_4665ee12_3a1f_44a4_bea3_0fccba634dc1),"items"===t&&(o=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a),"maps"===t&&(o=maps_90f36752_8815_4be8_b32b_d7fad1d0542e),"events"===t&&(o=events_c12a15a8_c380_4b28_8144_256cba95f760),"enemys"===t){for(a in core.enemys.enemys=o,o)core.enemys.enemys[a].id=a;core.material.enemys=core.getEnemys()}else if("icons"===t)core.icons.icons=o,core.material.icons=core.getIcons();else if("items"===t){for(n in core.items.items=o,o)core.items.items[n].id=n;core.material.items=core.getItems()}else"maps"===t?(core.maps.blocksInfo=o,core.status.mapBlockObjs={},core.status.number2block={},Object.values(core.status.maps).forEach((function(e){return delete e.blocks})),core.extractBlocks(),core.setWeather(core.animateFrame.weather.type,core.animateFrame.weather.level),core.drawMap()):"events"===t?core.events.commonEvent=o.commonEvent:"data"===t&&location.reload();core.updateStatusBar(!0,!0),console.log("Data hot reload: ".concat(t));case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}(),core.control.updateDamage=function(e,t){if((e=e||core.status.floorId)&&!core.status.gameOver&&"play"==main.mode){var r=null==t;if(core.hasItem("book")){if(core.status.damage.posX=core.bigmap.posX,core.status.damage.posY=core.bigmap.posY,!r)if(core.floors[e].width*core.floors[e].height>core.bigmap.threshold)return;this._updateDamage_damage(e,r),this._updateDamage_extraDamage(e,r),getItemDetail(e,r),this.drawDamage(t)}}},control.prototype.checkBlock=function(e){var t=core.getHeroLoc("x"),r=core.getHeroLoc("y"),o=t+","+r,a=core.status.checkBlock.damage[o];if(a){main.replayChecking||core.addPop(32*(t-core.bigmap.offsetX/32)+12,32*(r-core.bigmap.offsetY/32)+20,-a.toString()),core.status.hero.hp-=a;var n=Object.keys(core.status.checkBlock.type[o]||{}).join("，")||"伤害";if(core.drawTip("受到"+n+a+"点"),core.drawHeroAnimate("zone"),this._checkBlock_disableQuickShop(),core.status.hero.statistics.extraDamage+=a,core.status.hero.hp<=0)return core.status.hero.hp=0,core.updateStatusBar(),void core.events.lose();core.updateStatusBar()}this._checkBlock_repulse(core.status.checkBlock.repulse[o]),checkMockery(o,e)},control.prototype.moveHero=function(e,t){if(0==core.status.heroMoving){core.isset(e)&&core.setHeroLoc("direction",e);var r=core.nextX(),o=core.nextY();if(core.status.checkBlock.mockery["".concat(r,",").concat(o)]&&core.autosave(),t)return this.moveAction(t);this._moveHero_moving()}};var values={1:["crit"],6:["n"],7:["hungry"],8:["together"],10:["courage"],11:["charge"]},cannotStudy=[9,12,14,15,24];function canStudySkill(e){var t,r,o=null!==(r=(t=core.status.hero).special)&&void 0!==r?r:t.special={num:[],last:[]};return 0!==core.plugin.skillTree.getSkillLevel(11)&&(!(o.num.length>=1)&&(!o.num.includes(e)&&!cannotStudy.includes(e)))}function studySkill(e,t){var r,o,a;null!==(o=(r=core.status.hero).special)&&void 0!==o||(r.special={num:[],last:[]});var n=core.status.hero.special,c=core.getSpecials()[t-1][1];if(c instanceof Function&&(c=c(e)),canStudySkill(t)){n.num.push(t),n.last.push(3*core.plugin.skillTree.getSkillLevel(11)+2);var s,l=_createForOfIteratorHelper(null!==(a=values[t])&&void 0!==a?a:[]);try{for(l.s();!(s=l.n()).done;){var i=s.value;n[i]=e[i]}}catch(e){l.e(e)}finally{l.f()}}else main.replayChecking||core.tip("error","无法学习".concat(c))}function forgetStudiedSkill(e,t){var r,o=core.status.hero.special,a=null!=t?t:o.num.indexOf(e);if(-1!==a){o.num.splice(a,1),o.last.splice(a,1);var n,c=_createForOfIteratorHelper(null!==(r=values[number])&&void 0!==r?r:[]);try{for(c.s();!(n=c.n()).done;){delete o[n.value]}}catch(e){c.e(e)}finally{c.f()}}}function declineStudiedSkill(){var e,t,r=null!==(t=(e=core.status.hero).special)&&void 0!==t?t:e.special={num:[],last:[]};r.last=r.last.map((function(e){return e-1}))}function checkStudiedSkill(){for(var e=core.status.hero.special,t=0;t<e.last.length;t++)e.last[t]<=0&&(this.forgetStudiedSkill(void 0,t),t--)}core.plugin.study={canStudySkill:canStudySkill,studySkill:studySkill,forgetStudiedSkill:forgetStudiedSkill,declineStudiedSkill:declineStudiedSkill,checkStudiedSkill:checkStudiedSkill};var study=Object.freeze({__proto__:null,canStudySkill:canStudySkill,checkStudiedSkill:checkStudiedSkill,declineStudiedSkill:declineStudiedSkill,forgetStudiedSkill:forgetStudiedSkill,studySkill:studySkill}),replayableSettings=["autoSkill"],cliping=!1,startIndex=0;function ready(){}function readyClip(){return cliping=!0,startIndex=core.status.route.length-1}function clip(){var e;cliping&&(cliping=!1,core.status.route.splice(startIndex),(e=core.status.route).push.apply(e,arguments))}core.registerReplayAction("settings",(function(name){if(!name.startsWith("set:"))return!1;var _name$split=name.split(":"),_name$split2=_slicedToArray(_name$split,3),setting=_name$split2[1],value=_name$split2[2],v=eval(value);return"boolean"==typeof v&&(!!replayableSettings.includes(setting)&&(flags[setting]=v,core.status.route.push(name),core.replay(),!0))})),core.registerReplayAction("upgradeSkill",(function(e){if(!e.startsWith("skill:"))return!1;var t=parseInt(e.slice(6));return core.plugin.skillTree.upgradeSkill(t),core.status.route.push(e),core.replay(),!0})),core.registerReplayAction("study",(function(e){if(!e.startsWith("study:"))return!1;var t=_slicedToArray(e.slice(6).split(",").map((function(e){return parseInt(e)})),3),r=t[0],o=t[1],a=t[2];if(!canStudySkill(r))return!1;var n=core.getBlockId(o,a),c=core.getEnemyInfo(n,void 0,o,a);return!!c.special.includes(r)&&(studySkill(c,r),core.status.route.push(e),core.replay(),!0)}));var shopOpened=!1,openedShopId="";function drawHalo(e,t){if(!main.replayChecking&&core.getLocalStorage("showHalo",!0)){var r=core.status.checkBlock.halo;e.save();for(var o=0,a=Object.entries(r);o<a.length;o++){var n,c=_slicedToArray(a[o],2),s=c[0],l=c[1],i=_slicedToArray(s.split(",").map((function(e){return parseInt(e)})),2),u=i[0],d=i[1],f=_createForOfIteratorHelper(l);try{for(f.s();!(n=f.n()).done;){var p=_slicedToArray(n.value.split(":"),4),h=p[0],m=p[1],g=p[2],v=p[3];if("square"===h){var y=parseInt(m),b=Math.floor(y/2),_=u-b,k=u+b,w=d-b,S=d+b;if(t&&core.bigmap.v2&&(_-=core.bigmap.posX,w-=core.bigmap.posY,k-=core.bigmap.posX,S-=core.bigmap.posY,k<-1||_>core._PX_/32+1||w<-1||S>core._PY_/32+1))continue;e.fillStyle=g,e.strokeStyle=null!=v?v:g,e.lineWidth=1,e.globalAlpha=.1,e.fillRect(32*_,32*w,32*y,32*y),e.globalAlpha=.6,e.strokeRect(32*_,32*w,32*y,32*y)}}}catch(e){f.e(e)}finally{f.f()}}e.restore()}}core.registerReplayAction("openShop",(function(e){return!!e.startsWith("openShop:")&&(!shopOpened&&(openedShopId=e.slice(9),shopOpened=!0,core.status.route.push(e),core.replay(),!0))})),core.registerReplayAction("buy",(function(e){var t,r,o,a,n,c,s;if(!e.startsWith("buy:")&&!e.startsWith("sell:"))return!1;if(!shopOpened)return!1;if(!openedShopId)return!1;var l=_slicedToArray(e.split(":").map((function(e){return/^\d+$/.test(e)?parseInt(e):e})),3),i=l[0],u=l[1],d=l[2],f=core.status.shops[openedShopId].choices.find((function(e){return e.id===u}));if(!f)return!1;if(null!==(r=(t=flags).itemShop)&&void 0!==r||(t.itemShop={}),null!==(n=(o=flags.itemShop)[a=openedShopId])&&void 0!==n||(o[a]={}),null!==(s=(c=flags.itemShop[openedShopId])[u])&&void 0!==s||(c[u]=0),d>f.number-flags.itemShop[openedShopId][u])return!1;var p=0;return!((p="buy"===i?f.money*d:-f.sell*d)>core.status.hero.money)&&(core.status.hero.money-=p,flags.itemShop[openedShopId][u]+="buy"===i?d:-d,core.addItem(u,"buy"===i?d:-d),core.status.route.push(e),core.replay(),!0)})),core.registerReplayAction("closeShop",(function(e){return"closeShop"===e&&(!!shopOpened&&(shopOpened=!1,openedShopId="",core.status.route.push(e),core.replay(),!0))})),core.plugin.replay={ready:ready,readyClip:readyClip,clip:clip},function(){if(main.replayChecking)return core.plugin.gameUi={openItemShop:function(){return 0},showChapter:function(){return 0},openSkill:function(){return 0}};ui.prototype.drawBook=function(){if(!core.isReplaying())return core.plugin.bookOpened.value=!0},ui.prototype._drawToolbox=function(){if(!core.isReplaying())return core.plugin.toolOpened.value=!0},ui.prototype._drawEquipbox=function(){if(!core.isReplaying())return core.plugin.equipOpened.value=!0},ui.prototype.drawFly=function(){if(!core.isReplaying())return core.plugin.flyOpened.value=!0},control.prototype.updateStatusBar_update=function(){core.control.updateNextFrame=!1,core.isPlaying()&&!core.hasFlag("__statistics__")&&(core.control.controldata.updateStatusBar(),core.control.noAutoEvents||core.checkAutoEvents(),core.control._updateStatusBar_setToolboxIcon(),core.clearRouteFolding(),core.control.noAutoEvents=!0,main.replayChecking||(core.plugin.statusBarStatus.value=!core.plugin.statusBarStatus.value,core.checkMarkedEnemy()))},control.prototype.showStatusBar=function(){"editor"!=main.mode&&(core.removeFlag("hideStatusBar"),core.plugin.showStatusBar.value=!0,core.dom.tools.hard.style.display="block",core.dom.toolBar.style.display="block")},control.prototype.hideStatusBar=function(e){if("editor"!=main.mode){core.domStyle.showStatusBar||this.showStatusBar(),core.isReplaying()&&(e=!0),core.plugin.showStatusBar.value=!1;var t=core.dom.tools;if(core.setFlag("hideStatusBar",!0),core.setFlag("showToolbox",e||null),!core.domStyle.isVertical&&!core.flags.extendToolbar||!e)for(var r=0;r<t.length;++r)t[r].style.display="none";core.domStyle.isVertical||core.flags.extendToolbar||(core.dom.toolBar.style.display="none")}},core.plugin.gameUi={openItemShop:function(e){core.isReplaying()||(core.plugin.openedShopId=e,core.plugin.shopOpened.value=!0)},openSkill:function(){core.isReplaying()||(core.plugin.skillOpened.value=!0)},showChapter:function(e){core.isReplaying()||(core.plugin.chapterContent.value=e,core.plugin.chapterShowed.value=!0)}}}(),core.plugin.halo={drawHalo:drawHalo};var halo=Object.freeze({__proto__:null,drawHalo:drawHalo});function getHeroStatusOn(e,t,r,o){return getHeroStatusOf(core.status.hero,e,t,r,o)}function getHeroStatusOf(e,t,r,o,a){return getRealStatus(e,t,r,o,a)}function getRealStatus(e,t,r,o,a){if(t instanceof Array)return Object.fromEntries(t.map((t=>[t,getRealStatus(e,t,r,o,a)])));if("all"===t)return Object.fromEntries(Object.keys(core.status.hero).map((t=>[t,"all"!==t&&getRealStatus(e,t,r,o,a)])));let n=e?.[t]??core.status.hero[t];if(null==n)throw new ReferenceError(`Wrong hero status property name is delivered: ${t}`);if(r??=core.status.hero.loc.x,o??=core.status.hero.loc.y,a??=core.status.floorId,"atk"!==t&&"def"!==t||(n+=window.flags?.[`night_${a}`]??0),flags.bladeOn&&flags.blade){const e=core.plugin.skillTree.getSkillLevel(2);"atk"===t&&(n*=1+.1*e),"def"===t&&(n*=1-.1*e)}if(flags.shield&&flags.shieldOn){const e=core.plugin.skillTree.getSkillLevel(10);"atk"===t&&(n*=1-.1*e),"def"===t&&(n*=1+.1*e)}return"number"==typeof n&&(n*=core.getBuff(t)),"number"==typeof n&&(n=Math.floor(n)),n}core.plugin.hero={getHeroStatusOf:getHeroStatusOf,getHeroStatusOn:getHeroStatusOn};var hero=Object.freeze({__proto__:null,getHeroStatusOf:getHeroStatusOf,getHeroStatusOn:getHeroStatusOn});function slide(e,t){return 0===t?e:(t%=e.length)>0?(e.unshift(...e.splice(e.length-t,t)),e):t<0?(e.push(...e.splice(0,-t)),e):e}function backDir(e){return{up:"down",down:"up",left:"right",right:"left"}[e]}function has(e){return null!=e}function maxGameScale(e=0){const t=core.domStyle.availableScale.indexOf(core.domStyle.scale);core.control.setDisplayScale(core.domStyle.availableScale.length-1-t-e),!core.isPlaying()&&core.flags.enableHDCanvas&&(core.domStyle.ratio=Math.max(window.devicePixelRatio||1,core.domStyle.scale),core.resize())}function ensureArray(e){return e instanceof Array?e:[e]}function ofDir(e,t,r){const{x:o,y:a}=core.utils.scan2[r];return[e+o,t+a]}core.plugin.utils={slide:slide,backDir:backDir,has:has,maxGameScale:maxGameScale,ofDir:ofDir},core.has=has;var utils=Object.freeze({__proto__:null,backDir:backDir,ensureArray:ensureArray,has:has,maxGameScale:maxGameScale,ofDir:ofDir,slide:slide}),list=["tower6"];function setLoopMap(e,t){var r=core.status.maps[t];e<9&&moveMap(r.width-17,t),e>r.width-9&&moveMap(17-r.width,t)}function autoSetLoopMap(e){setLoopMap(core.status.hero.loc.x,e)}function checkLoopMap(){isLoopMap(core.status.floorId)&&autoSetLoopMap(core.status.floorId)}function moveMap(e,t){core.extractBlocks(t);var r=core.status.maps[t];core.setHeroLoc("x",core.status.hero.loc.x+e),flags["loop_".concat(t)]+=e,flags["loop_".concat(t)]%=r.width;for(var o=r.blocks.slice(),a=0;a<o.length;a++)core.removeBlockByIndex(0,t),core.removeGlobalAnimate(o[a].x,o[a].y);o.forEach((function(o){var a=o.x+e;a>=r.width&&(a-=r.width),a<0&&(a+=r.width),core.setBlock(o.id,a,o.y,t,!0),core.setMapBlockDisabled(t,a,o.y,!1)})),core.drawMap(),core.drawHero()}function isLoopMap(e){return list.includes(e)}events.prototype._sys_changeFloor=function(e,t){var r={};if(isLoopMap((e=e.event.data).floorId)){var o,a,n,c=core.status.maps[e.floorId];null!==(n=(o=flags)[a="loop_".concat(e.floorId)])&&void 0!==n||(o[a]=0);var s=e.loc[0]+flags["loop_".concat(e.floorId)];(s%=c.width)<0&&(s+=c.width),r={x:s,y:e.loc[1]}}else e.loc&&(r={x:e.loc[0],y:e.loc[1]});e.direction&&(r.direction=e.direction),"action"!=core.status.event.id&&(core.status.event.id=null),core.changeFloor(e.floorId,e.stair,r,e.time,(function(){core.replay(),t&&t()}))},events.prototype.trigger=function(x,y,callback){var _executeCallback=function(){callback&&setTimeout(callback,1)};if(core.status.gameOver)return _executeCallback();if("action"==core.status.event.id)return core.insertAction({type:"function",function:"function () { core.events._trigger_inAction("+x+","+y+"); }",async:!0},null,null,null,!0),_executeCallback();if(core.status.event.id)return _executeCallback();var block=core.getBlock(x,y),id=core.status.floorId,loop=isLoopMap(id);if(loop&&0!==flags["loop_".concat(id)])if(block&&"changeFloor"===block.event.trigger)delete block.event.trigger,core.maps._addInfo(block);else{var floor=core.status.maps[id],tx=x-flags["loop_".concat(id)];tx%=floor.width,tx<0&&(tx+=floor.width);var c=core.floors[id].changeFloor["".concat(tx,",").concat(y)];if(c){var b={event:{},x:tx,y:y};b.event.data=c,b.event.trigger="changeFloor",block=b}}if(null==block)return _executeCallback();if(block.event.script){core.clearRouteFolding();try{eval(block.event.script)}catch(e){console.error(e)}}if(block.event.event)return core.clearRouteFolding(),core.insertAction(block.event.event,block.x,block.y),_executeCallback();if(block.event.trigger&&"null"!=block.event.trigger){var noPass=block.event.noPass,trigger=block.event.trigger;if(noPass&&core.clearAutomaticRouteNode(x,y),"changeFloor"==trigger&&!noPass&&this._trigger_ignoreChangeFloor(block)&&!loop)return _executeCallback();core.status.automaticRoute.moveDirectly=!1,this.doSystemEvent(trigger,block)}return _executeCallback()},maps.prototype._getBgFgMapArray=function(e,t,r){if(!(t=t||core.status.floorId))return[];var o=core.floors[t].width,a=core.floors[t].height;if(!r&&core.status[e+"maps"][t])return core.status[e+"maps"][t];var n,c,s,l="editor"!=main.mode||window.editor&&editor.uievent&&editor.uievent.isOpen?null:core.cloneArray(editor[e+"map"]);(null==l&&(l=core.cloneArray(core.floors[t][e+"map"]||[])),isLoopMap(t)&&window.flags)&&(null!==(s=(n=flags)[c="loop_".concat(t)])&&void 0!==s||(n[c]=0),l.forEach((function(e){slide(e,flags["loop_".concat(t)]%o)})));for(var i=0;i<a;++i)null==l[i]&&(l[i]=Array(o).fill(0));if((core.getFlag("__"+e+"v__",{})[t]||[]).forEach((function(e){l[e[1]][e[0]]=e[2]||0})),(core.getFlag("__"+e+"d__",{})[t]||[]).forEach((function(e){l[e[1]][e[0]]=0})),"editor"==main.mode)for(var u=0;u<o;u++)for(i=0;i<a;i++)l[i][u]=l[i][u].idnum||l[i][u]||0;return core.status[e+"maps"]&&(core.status[e+"maps"][t]=l),l},core.plugin.loopMap={checkLoopMap:checkLoopMap};var loopMap=Object.freeze({__proto__:null,checkLoopMap:checkLoopMap});function checkRemainEnemy(e){var t={};return e.forEach((function(e){core.extractBlocks(e),core.status.maps[e].blocks.forEach((function(r){var o;if(r.event.cls.startsWith("enemy")&&!r.disable){var a=r.event.id;null!==(o=t[e])&&void 0!==o||(t[e]=[]),t[e].push({loc:[r.x,r.y],id:a})}}))})),t}function getRemainEnemyString(e){var t=checkRemainEnemy(e),r=[],o=[],a=function(){var e=t[n],a={};e.forEach((function(e){var t,r=e.id;null!==(t=a[r])&&void 0!==t||(a[r]=0),a[r]++}));var c=core.status.maps[n].title;for(var s in a){var l=core.material.enemys[s].name;o.push("".concat(c,"(").concat(n,"): ").concat(l," * ").concat(a[s])),10===o.length&&(r.push(o.join("\n")),o=[])}};for(var n in t)a();return o.length>0&&(r.push(o.join("\n")),r[0]="当前剩余怪物：\n".concat(r[0])),r}core.plugin.remainEnemy={checkRemainEnemy:checkRemainEnemy,getRemainEnemyString:getRemainEnemyString};var remainEnemy=Object.freeze({__proto__:null,checkRemainEnemy:checkRemainEnemy,getRemainEnemyString:getRemainEnemyString});function removeMaps(e,t,r){var o,a;t=t||e;var n=core.floorIds.indexOf(e),c=core.floorIds.indexOf(t);c<0&&(c=core.floorIds.length-1),flags.__visited__=flags.__visited__||{},flags.__removed__=flags.__removed__||[],flags.__disabled__=flags.__disabled__||{},flags.__leaveLoc__=flags.__leaveLoc__||{},null!==(a=(o=flags).__forceDelete__)&&void 0!==a||(o.__forceDelete__={});for(var s=!1,l=n;l<=c;++l){var i=core.floorIds[l];core.status.maps[i].deleted||(delete flags.__visited__[i],flags.__removed__.push(i),delete flags.__disabled__[i],delete flags.__leaveLoc__[i],(core.status.autoEvents||[]).forEach((function(e){e.floorId==i&&e.currentFloor&&(core.autoEventExecuting(e.symbol,!1),core.autoEventExecuted(e.symbol,!1))})),core.status.maps[i].deleted=!0,core.status.maps[i].canFlyTo=!1,core.status.maps[i].canFlyFrom=!1,core.status.maps[i].cannotViewMap=!0,r&&(core.status.maps[i].forceDelete=!0,flags.__forceDelete__[i]=!0),deleteFlags(i),s=!0)}s&&!main.replayChecking&&core.splitArea()}function deleteFlags(e){delete flags["jump_".concat(e)],delete flags["inte_".concat(e)],delete flags["loop_".concat(e)],delete flags["melt_".concat(e)],delete flags["night_".concat(e)]}function resumeMaps(e,t){t=t||e;var r=core.floorIds.indexOf(e),o=core.floorIds.indexOf(t);o<0&&(o=core.floorIds.length-1),flags.__removed__=flags.__removed__||[];for(var a=r;a<=o;++a){var n=core.floorIds[a];core.status.maps[n].deleted&&(core.status.maps[n].forceDelete||flags.__forceDelete__[n]||(flags.__removed__=flags.__removed__.filter((function(e){return e!=n})),core.status.maps[n]=core.loadFloor(n)))}}var inAnyPartition=function(e){var t=!1;return(core.floorPartitions||[]).forEach((function(r){var o=core.floorIds.indexOf(r[0]),a=core.floorIds.indexOf(r[1]),n=core.floorIds.indexOf(e);o<0||n<0||(a<0&&(a=core.floorIds.length-1),n>=o&&n<=a&&(t=!0))})),t};function autoRemoveMaps(e){"play"==main.mode&&inAnyPartition(e)&&(core.floorPartitions||[]).forEach((function(t){var r=core.floorIds.indexOf(t[0]),o=core.floorIds.indexOf(t[1]),a=core.floorIds.indexOf(e);r<0||a<0||(o<0&&(o=core.floorIds.length-1),a>=r&&a<=o?core.plugin.removeMap.resumeMaps(core.floorIds[r],core.floorIds[o]):removeMaps(core.floorIds[r],core.floorIds[o]))}))}core.plugin.removeMap={removeMaps:removeMaps,deleteFlags:deleteFlags,resumeMaps:resumeMaps,autoRemoveMaps:autoRemoveMaps};var removeMap=Object.freeze({__proto__:null,autoRemoveMaps:autoRemoveMaps,deleteFlags:deleteFlags,removeMaps:removeMaps,resumeMaps:resumeMaps}),openItemShop=core.plugin.gameUi.openItemShop;function openShop(e,t){var r=core.status.shops[e];return this.canOpenShop(e)?!r.item||void(openItemShop&&openItemShop(e)):(core.drawTip("该商店尚未开启"),!1)}function isShopVisited(e){var t,r;null!==(r=(t=flags).__shops__)&&void 0!==r||(t.__shops__={});var o=core.getFlag("__shops__");return o[e]||(o[e]={}),o[e].visited}function listShopIds(){return Object.keys(core.status.shops).filter((function(e){return core.plugin.shop.isShopVisited(e)||!core.status.shops[e].mustEnable}))}function canOpenShop(e){if(this.isShopVisited(e))return!0;var t=core.status.shops[e];return!(t.item||t.commonEvent||t.mustEnable)}function setShopVisited(e,t){core.hasFlag("__shops__")||core.setFlag("__shops__",{});var r=core.getFlag("__shops__");r[e]||(r[e]={}),t?r[e].visited=!0:delete r[e].visited}function canUseQuickShop(){return!1===core.status.thisMap.canUseQuickShop?"当前楼层不能使用快捷商店。":null}core.plugin.shop={openShop:openShop,isShopVisited:isShopVisited,listShopIds:listShopIds,canOpenShop:canOpenShop,setShopVisited:setShopVisited,canUseQuickShop:canUseQuickShop};var shop=Object.freeze({__proto__:null,canOpenShop:canOpenShop,canUseQuickShop:canUseQuickShop,isShopVisited:isShopVisited,listShopIds:listShopIds,openShop:openShop,setShopVisited:setShopVisited}),ignoreInJump={event:["X20007","X20001","X20006","X20014","X20010","X20007"],bg:["X20037","X20038","X20039","X20045","X20047","X20053","X20054","X20055","X20067","X20068","X20075","X20076"]},jumpIgnoreFloor=["MT31","snowTown","MT36","MT37","MT38","MT39","MT40","MT42","MT43","MT44","MT45","MT46","MT47","MT48","MT49","MT50"];function jumpSkill(){if(core.status.floorId.startsWith("tower"))return core.drawTip("当无法使用该技能");if(jumpIgnoreFloor.includes(core.status.floorId)||flags.onChase)return core.drawTip("当前楼层无法使用该技能");if(flags.skill2){if(flags["jump_"+core.status.floorId]||(flags["jump_"+core.status.floorId]=0),"MT14"==core.status.floorId){var e=core.status.hero.loc;if(77===e.x&&5===e.y&&(flags.MT14Jump=!0),2===flags.jump_MT14&&!flags.MT14Jump)return core.drawTip("该地图还有一个必跳的地方，你还没有跳")}if(flags["jump_"+core.status.floorId]>=3)return core.drawTip("当前地图使用次数已用完");var t=core.status.hero.loc.direction,r=core.status.hero.loc,o={};switch(t){case"up":o.x=r.x,o.y=r.y-1;break;case"right":o.x=r.x+1,o.y=r.y;break;case"down":o.x=r.x,o.y=r.y+1;break;case"left":o.x=r.x-1,o.y=r.y}var a=core.getBlockCls(o.x,o.y),n=core.noPass(o.x,o.y),c=core.getBlockId(o.x,o.y)||"",s=core.getBlockByNumber(core.getBgNumber(o.x,o.y)).event.id||"";if(!n||"items"==a||c.startsWith("X")&&!ignoreInJump.event.includes(c)||s.startsWith("X")&&!ignoreInJump.bg.includes(s))return core.drawTip("当前无法使用技能");if(n&&"enemys"!=a&&"enemy48"!=a){var l=u(t,o.x,o.y,!0);if(!l)return;core.autosave(),flags.chapter<=1&&(core.status.hero.hp-=200*flags.hard),core.updateStatusBar(),flags["jump_"+core.status.floorId]++,core.status.hero.hp<=0&&(core.status.hero.hp=0,core.updateStatusBar(),core.events.lose("你跳死了")),core.playSound("015-Jump01.ogg"),core.insertAction([{type:"jumpHero",loc:[l.x,l.y],time:500}])}if("enemys"==a||"enemy48"==a){var i=u(t,o.x,o.y,!1);if(!i)return;core.autosave(),flags.chapter<=1&&(core.status.hero.hp-=200*flags.hard),core.updateStatusBar(),flags["jump_"+core.status.floorId]++,core.status.hero.hp<=0&&(core.status.hero.hp=0,core.updateStatusBar(),core.events.lose("你跳死了")),core.playSound("015-Jump01.ogg"),core.insertAction([{type:"jump",from:[o.x,o.y],to:[i.x,i.y],time:500,keep:!0}])}}function u(e,t,r,o){switch(o||(o=!1),e){case"up":r--;break;case"right":t++;break;case"down":r++;break;case"left":t--}if(t>core.status.thisMap.width-1||r>core.status.thisMap.height-1||t<0||r<0)return core.drawTip("当前无法使用技能");var a=core.getBlockId(t,r)||"";if(core.getBgNumber(t,r))var n=core.getBlockByNumber(core.getBgNumber(t,r)).event.id||"";else n="";return core.noPass(t,r)||"items"==core.getBlockCls(t,r)||a.startsWith("X")&&!ignoreInJump.event.includes(a)||n.startsWith("X")&&!ignoreInJump.bg.includes(n)||"animates"==core.getBlockCls(t,r)?u(e,t,r,!0):o?{x:t,y:r}:u(e,t,r,!1)}}core.plugin.skillEffects={jumpSkill:jumpSkill,jumpIgnoreFloor:jumpIgnoreFloor};var skills$2=Object.freeze({__proto__:null,jumpIgnoreFloor:jumpIgnoreFloor,jumpSkill:jumpSkill}),levels=[],skills$1={chapter1:[{index:0,title:"力量",desc:["力量就是根本！可以通过智慧增加力量，每级增加2点攻击。"],consume:"10 * level + 10",front:[],loc:[1,2],max:10,effect:["攻击 + ${level * 2}"]},{index:1,title:"致命一击",desc:["爆发出全部力量攻击敌人，每级增加5点额外攻击。"],consume:"30 * level + 30",front:[[0,5]],loc:[2,1],max:10,effect:["额外攻击 + ${level * 5}"]},{index:2,title:"断灭之刃",desc:['<span style="color: gold">主动技能，快捷键1</span>，',"开启后会在战斗时会额外增加一定量的攻击，但同时减少一定量的防御。"],consume:"200 * level + 400",front:[[1,5]],loc:[4,1],max:5,effect:["增加${level * 10}%攻击，减少${level * 10}%防御"]},{index:3,title:"坚韧",desc:["由智慧转化出坚韧！每级增加2点防御"],consume:"10 * level + 10",front:[],loc:[1,4],max:10,effect:["防御 + ${level * 2}"]},{index:4,title:"回春",desc:["让智慧化为治愈之泉水！每级增加1点生命回复"],consume:"20 * level + 20",front:[[3,5]],loc:[2,5],max:25,effect:["生命回复 + ${level}"]},{index:5,title:"治愈之泉",desc:["让生命变得更多一些吧！每吃50瓶血瓶就增加当前生命回复10%的生命回复"],consume:"1500",front:[[4,25]],loc:[4,5],max:1,effect:["50瓶血10%生命回复"]},{index:6,title:"坚固之盾",desc:["让护甲更加坚硬一些吧！每级增加10点防御"],consume:"50 + level * 50",front:[[3,5]],loc:[2,3],max:10,effect:["防御 + ${level * 10}"]},{index:7,title:"无上之盾",desc:['<span style="color: #dd4">第一章终极技能</span>，战斗时智慧的 1/10 会充当等量护盾。'],consume:"2500",front:[[6,10],[5,1],[2,2]],loc:[5,3],max:1,effect:["战斗时智慧会充当护盾"]}],chapter2:[{index:8,title:"锋利",desc:["让剑变得更加锋利！每级使攻击增加1%（buff式增加）"],consume:"level > 5 ? 50 * level ** 2 : 250 * level + 250",front:[],loc:[1,2],max:15,effect:["攻击增加${level}%"]},{index:9,title:"坚硬",desc:["让盾牌变得更加坚固！每级使防御增加1%（buff式增加）"],consume:"level > 5 ? 50 * level ** 2 : 250 * level + 250",front:[],loc:[1,4],max:15,effect:["防御增加${level}%"]},{index:10,title:"铸剑为盾",desc:['<span style="color: gold">主动技能，快捷键3</span>，',"减少一定的攻击，增加一定的防御"],consume:"1000 * level ** 2 + 1000",front:[[9,5]],loc:[2,5],max:5,effect:["增加${level * 10}%的防御，减少${level * 10}%的攻击"]},{index:11,title:"学习",desc:['<span style="color: gold">主动技能</span>，可以消耗500智慧学习一个怪物的技能，',"持续5场战斗，每学习一次消耗的智慧点增加250，每次升级使持续的战斗次数增加3次。更多信息可在学习后在百科全书查看。"],consume:"2500 * 2 ** level + 5000",front:[[8,10],[12,5]],loc:[4,1],max:6,effect:["学习怪物技能，持续${level * 3 + 2}场战斗"]},{index:12,title:"聪慧",desc:["使主角变得更加聪明，每级使绿宝石增加的智慧点上升5%"],consume:"level > 5 ? 100 * level ** 2 : 250 * level + 1250",front:[[8,10],[9,10]],loc:[3,3],max:20,effect:["增加${level * 5}%绿宝石效果"]},{index:13,title:"治愈",desc:["使主角能够更好地回复生命，每级使血瓶的加血量增加2%"],consume:"level > 5 ? 100 * level ** 2 : 250 * level + 1250",front:[[10,3]],loc:[4,5],max:20,effect:["增加${level * 2}%的血瓶回血量"]},{index:14,title:"胜利之号",desc:['<span style="color: #dd4">第二章终极技能</span>，',"每打一个怪物，勇士在本楼层对怪物造成的伤害便增加1%"],consume:"15000",front:[[13,10],[12,10],[11,3]],loc:[5,3],max:1,effect:["每打一个怪，勇士造成的伤害增加1%"]}]};function resetSkillLevel(){levels=[]}function getSkillFromIndex(e){for(var t=0,r=Object.entries(skills$1);t<r.length;t++){var o=_slicedToArray(r[t],2)[1].find((function(t){return t.index===e}));if(o)return o}}function getSkillLevel(e){var t,r;return null!==(r=(t=levels)[e])&&void 0!==r?r:t[e]=0}function getSkillConsume(skill){return eval(getSkillFromIndex(skill).consume.replace(/level(:\d+)?/g,(function(e,t){return"core.plugin.skillTree.getSkillLevel(".concat(t||skill,")")})))}function openTree(){main.replayChecking||(core.plugin.skillTreeOpened.value=!0)}function canUpgrade(e){if(core.plugin.skillTree.getSkillConsume(e)>core.status.hero.mdef)return!1;var t=core.plugin.skillTree.getSkillLevel(e),r=getSkillFromIndex(e);if(t===r.max)return!1;var o,a=_createForOfIteratorHelper(r.front);try{for(a.s();!(o=a.n()).done;){var n=_slicedToArray(o.value,2),c=n[0],s=n[1];if(core.plugin.skillTree.getSkillLevel(c)<s)return!1}}catch(e){a.e(e)}finally{a.f()}return!0}function upgradeSkill(e){if(!canUpgrade(e))return!1;switch(e){case 0:core.status.hero.atk+=2;break;case 1:core.status.hero.mana+=5;break;case 2:core.setFlag("bladeOn",!0);break;case 3:core.status.hero.def+=2;break;case 4:core.status.hero.hpmax+=1;break;case 5:core.setFlag("spring",!0);break;case 6:core.status.hero.def+=10;break;case 7:core.setFlag("superSheild",!0);break;case 8:core.addBuff("atk",.01);break;case 9:core.addBuff("def",.01);break;case 10:core.setFlag("shieldOn",!0);break;case 11:core.setItem("I565",1)}var t=getSkillConsume(e);return core.status.hero.mdef-=t,levels[e]++,core.updateStatusBar(),!0}function saveSkillTree(){return levels.slice()}function loadSkillTree(e){levels=null!=e?e:[]}core.plugin.skills=skills$1,core.plugin.skillTree={getSkillConsume:getSkillConsume,getSkillFromIndex:getSkillFromIndex,getSkillLevel:getSkillLevel,saveSkillTree:saveSkillTree,loadSkillTree:loadSkillTree,upgradeSkill:upgradeSkill,openTree:openTree,resetSkillLevel:resetSkillLevel};var skillTree=Object.freeze({__proto__:null,canUpgrade:canUpgrade,getSkillConsume:getSkillConsume,getSkillFromIndex:getSkillFromIndex,getSkillLevel:getSkillLevel,loadSkillTree:loadSkillTree,openTree:openTree,resetSkillLevel:resetSkillLevel,saveSkillTree:saveSkillTree,upgradeSkill:upgradeSkill}),stage=1,hp=1e4,seconds=0,boomLocs=[],heroHp;function initTowerBoss(){stage=1,hp=1e4,seconds=0,heroHp=core.status.hero.hp,dynamicChangeHp(0,1e4,1e4),core.insertAction([{type:"sleep",time:1e3,noSkip:!0}]),setTimeout(bossCore,1e3)}function healthBar(e,t){var r=e/t*476,o=[510-e/t*2*255,e/t*2*255,0,1];core.dymCanvas.healthBar?core.clearMap("healthBar"):core.createCanvas("healthBar",0,0,480,16,140),core.fillRect("healthBar",0,0,480,16,"#bbbbbb");var a=document.getElementById("healthBar").getContext("2d");a.shadowColor="rgba(0, 0, 0, 0.8)",a.shadowBlur=5,a.shadowOffsetX=10,a.shadowOffsetY=5,a.filter="blur(1px)",core.fillRect("healthBar",2,2,r,12,o),a.shadowColor="rgba(0, 0, 0, 0.5)",a.shadowOffsetX=0,a.shadowOffsetY=0,core.strokeRect("healthBar",1,1,478,14,"#ffffff",2),a.shadowColor="rgba(0, 0, 0, 1)",a.shadowBlur=3,a.shadowOffsetX=2,a.shadowOffsetY=1,a.filter="none",core.fillText("healthBar",e+"/"+t,5,13.5,"#ffffff","16px normal")}function dynamicChangeHp(e,t,r){var o=0,a=(t-e)/50,n=e,c=window.setInterval((function(){50==++o&&(clearInterval(c),healthBar(t,r)),healthBar(n+=a,r)}),20)}function skipWord(e,t,r,o){t=t||0,r=r||16,o=o||3e3,core.dymCanvas.words?core.clearMap("words"):core.createCanvas("words",t,r,480,24,135),flags.wordsTimeOut&&clearTimeout(flags.wordsTimeOut),dynamicCurtain(r,r+24,o/3);var a=document.getElementById("words").getContext("2d");a.shadowColor="rgba(0, 0, 0, 1)",a.shadowBlur=3,a.shadowOffsetX=2,a.shadowOffsetY=1,function t(r){if(parseInt(r)>=e.length)return void(flags.wordsTimeOut=setTimeout((function(){core.deleteCanvas("words"),core.deleteCanvas("wordsBg")}),o));var n=0,c=2,s=4+24*r,l=window.setInterval((function(){c-=.4,n++,core.clearMap("words",s,0,24,24),a.filter="blur("+c+"px)",core.fillText("words",e[r],s,20,"#ffffff","22px normal"),5==n&&(clearInterval(l),t(r+1))}),20)}(0)}function dynamicCurtain(e,t,r,o){o=o||480,core.dymCanvas.wordsBg?core.clearMap("wordsBg"):core.createCanvas("wordsBg",0,e,o,24,130),r/=1e3;var a=e,n=0,c=2*(t-e)/Math.pow(50*r,2),s=c*r*50,l=document.getElementById("wordsBg").getContext("2d");l.shadowColor="rgba(0, 0, 0, 0.8)";var i=window.setInterval((function(){n++,a+=s-=c,core.clearMap("wordsBg"),l.shadowBlur=8,l.shadowOffsetY=2,core.fillRect("wordsBg",0,0,o,a-e,[180,180,180,.7]),l.shadowBlur=3,l.shadowOffsetY=0,core.strokeRect("wordsBg",1,1,o-2,a-e-2,[255,255,255,.7],2),n>=50*r&&(clearInterval(i),core.clearMap("wordsBg"),l.shadowBlur=8,l.shadowOffsetY=2,core.fillRect("wordsBg",0,0,o,t-e,[180,180,180,.7]),l.shadowBlur=3,l.shadowOffsetY=0,core.strokeRect("wordsBg",1,1,o-2,a-e-2,[255,255,255,.7],2))}),20)}function attackBoss(){if(!(flags.canAttack||Math.random()<.8)){if(hp>3500)var e=Math.floor(13*Math.random()+1),t=Math.floor(13*Math.random()+1);else if(hp>2e3)e=Math.floor(11*Math.random()+2),t=Math.floor(11*Math.random()+2);else if(hp>1e3)e=Math.floor(9*Math.random()+3),t=Math.floor(9*Math.random()+3);else e=Math.floor(7*Math.random()+4),t=Math.floor(7*Math.random()+4);flags.canAttack=!0,core.dymCanvas.attackBoss?core.clearMap("attackBoss"):core.createCanvas("attackBoss",0,0,480,480,35);var r=document.getElementById("attackBoss").getContext("2d"),o=0,a=3,n=2,c=.04,s=window.setInterval((function(){core.clearMap("attackBoss"),o++,n-=c-=8e-4,a-=.06,r.filter="blur("+a+"px)",core.strokeCircle("attackBoss",32*e+16,32*t+16,16*n,[255,150,150,.7],4),core.fillCircle("attackBoss",32*e+16,32*t+16,3*n,[255,150,150,.7]),50==o&&(clearInterval(s),core.clearMap("attactkBoss"),r.filter="none",core.strokeCircle("attackBoss",32*e+16,32*t+16,16,[255,150,150,.7],4),core.fillCircle("attackBoss",32*e+16,32*t+16,3,[255,150,150,.7]))}),20),l=0,i=window.setInterval((function(){l++;var r=core.status.hero.loc.x,o=core.status.hero.loc.y;return l>100?(setTimeout((function(){delete flags.canAttack}),4e3),clearInterval(i),void core.deleteCanvas("attackBoss")):e==r&&t==o?(setTimeout((function(){delete flags.canAttack}),4e3),dynamicChangeHp(hp,hp-500,1e4),hp-=500,clearInterval(i),core.deleteCanvas("attackBoss"),void(hp>3500?core.drawAnimate("hand",7,1):hp>2e3?core.drawAnimate("hand",7,2):hp>1e3?core.drawAnimate("hand",7,3):core.drawAnimate("hand",7,4))):void 0}),20)}}function bossCore(){var e=window.setInterval((function(){1==stage&&(8==seconds&&skipWord("智慧之神：果然，你和别人不一样。"),12==seconds&&skipWord("智慧之神：你知道去躲避那些攻击。"),16==seconds&&skipWord("智慧之神：之前的那些人总会一头撞上我的攻击，悲剧收场。"),20==seconds&&skipWord("提示：踩在红圈上可以对智慧之神造成伤害"),seconds>10&&attackBoss(),seconds%10==0&&intelligentArrow(),seconds%7==0&&0!=seconds&&intelligentDoor(),seconds>20&&seconds%13==0&&icyMomentem()),1==stage&&hp<=7e3&&(stage++,seconds=0,skipWord("智慧之神：不错小伙子"),core.pauseBgm()),2==stage&&(4==seconds&&skipWord("智慧之神：你的确拥有智慧。"),8==seconds&&skipWord("智慧之神：或许你就是那个未来的救星。"),12==seconds&&skipWord("智慧之神：不过，这场战斗才刚刚开始"),25==seconds&&skipWord("提示：方形区域均为危险区域"),15==seconds&&setTimeout((function(){core.playSound("thunder.mp3")}),500),16==seconds&&startStage2(),seconds>20&&attackBoss(),seconds%4==0&&seconds>20&&randomThunder(),seconds>30&&seconds%12==0&&ballThunder()),hp<=3500&&2==stage&&(stage++,seconds=0,skipWord("智慧之神：不得不说小伙子"),core.pauseBgm()),stage>=3&&(4==seconds&&skipWord("智慧之神：拥有智慧就是不一样。"),8==seconds&&skipWord("智慧之神：不过，你还得再过我一关！"),12==seconds&&startStage3(),15==seconds&&(flags.booming=!0,randomBoom()),seconds>20&&attackBoss(),seconds>20&&seconds%10==0&&chainThunder(),2e3==hp&&3==stage&&(stage++,flags.booming=!1,skipWord("智慧之神：还没有结束！"),startStage4(),setTimeout((function(){flags.booming=!0,randomBoom()}),5e3)),1e3==hp&&4==stage&&(stage++,flags.booming=!1,skipWord("智慧之神：还没有结束！！！！！！"),startStage5(),setTimeout((function(){flags.booming=!0,randomBoom()}),5e3))),0==hp&&(clearInterval(e),clearInterval(flags.boom),core.status.hero.hp=heroHp,clip("choices:0"),delete flags.__bgm__,core.pauseBgm(),core.insertAction(["\t[智慧之神,E557]\b[down,7,4]看来你真的会成为那个拯救未来的人。","\t[智慧之神,E557]\b[down,7,4]记住，拥有智慧便可以掌控万物。","\t[低级智人]\b[up,hero]智慧？智慧到底是什么？","\t[智慧之神,E557]\b[down,7,4]最终，你会知道答案的。","\t[智慧之神,E557]\b[down,7,4]继续向东前进吧，那里能找到你想要的答案。",{type:"openDoor",loc:[13,6],floorId:"MT19"},"\t[智慧之神,E557]\b[down,7,4]我这就把你送出去",{type:"setValue",name:"flag:boss1",value:"true"},{type:"changeFloor",floorId:"MT20",loc:[7,9]},{type:"forbidSave"},{type:"showStatusBar"},{type:"function",function:"() => {\ncore.deleteAllCanvas();\n}"}])),seconds++}),1e3)}function intelligentArrow(e){var t=Math.floor(13*Math.random()+1),r=Math.random()>.5?"horizon":"vertical";if(!e)var o=Math.ceil(8*Math.random())+4,a=1,n=window.setInterval((function(){intelligentArrow(!0),++a>=o&&clearInterval(n)}),200);if(core.dymCanvas["inteArrow"+t+r])return intelligentArrow(!0);if(core.dymCanvas.danger1||core.createCanvas("danger1",0,0,480,480,35),"horizon"==r)for(var c=1;c<14;c++)core.fillRect("danger1",32*c+2,32*t+2,28,28,[255,0,0,.6]);else for(var s=1;s<14;s++)core.fillRect("danger1",32*t+2,32*s+2,28,28,[255,0,0,.6]);core.dymCanvas["inteArrow"+t+r]||core.createCanvas("inteArrow"+t+r,0,0,544,544,65),core.clearMap("inteArrow"+t+r),"horizon"==r?core.drawImage("inteArrow"+t+r,"arrow.png",448,32*t,102,32):core.drawImage("inteArrow"+t+r,"arrow.png",0,0,259,75,32*t-32,480,102,32,Math.PI/2),setTimeout((function(){core.playSound("arrow.mp3"),core.deleteCanvas("danger1");var e=0,o=0,a={},n=window.setInterval((function(){if(e+=o-=1,"horizon"==r?core.relocateCanvas("inteArrow"+t+r,e,0):core.relocateCanvas("inteArrow"+t+r,0,e),e<-480&&(core.deleteCanvas("inteArrow"+t+r),clearInterval(n)),!a[t+r]){var c=core.status.hero.loc.x,s=core.status.hero.loc.y;if("horizon"==r){if(s==t&&Math.floor((480+e)/32)==c&&(a[t+r]=!0,core.drawHeroAnimate("hand"),core.status.hero.hp-=1e3,core.addPop(32*c+16,32*s+16,-1e3),core.updateStatusBar(),core.status.hero.hp<0))return clearInterval(n),core.status.hero.hp=0,core.updateStatusBar(),void core.events.lose()}else if(c==t&&Math.floor((480+e)/32)==s&&(a[t+r]=!0,core.drawHeroAnimate("hand"),core.status.hero.hp-=1e3,core.addPop(32*c+16,32*s+16,-1e3),core.updateStatusBar(),core.status.hero.hp<0))return clearInterval(n),core.status.hero.hp=0,core.updateStatusBar(),void core.events.lose()}}),20)}),3e3)}function intelligentDoor(){if(!(Math.random()<.5)){var e=Math.floor(13*Math.random())+1,t=Math.floor(13*Math.random())+1;core.drawHeroAnimate("magicAtk"),core.dymCanvas["door"+e+"_"+t]?core.clearMap("door"+e+"_"+t):core.createCanvas("door"+e+"_"+t,0,0,480,480,35);var r=document.getElementById("door"+e+"_"+t).getContext("2d"),o=0,a=0,n=.64,c=window.setInterval((function(){if(!(++o<40)){if(100==o)return clearInterval(c),core.insertAction([{type:"changePos",loc:[e,t]}]),void setTimeout((function(){core.deleteCanvas("door"+e+"_"+t)}),2e3);a+=2*n,n-=.0128,core.clearMap("door"+e+"_"+t),r.shadowColor="rgba(255, 255, 255, 1)",r.shadowBlur=7,r.filter="blur(5px)",core.fillRect("door"+e+"_"+t,32*e,32*t-24,a,48,[255,255,255,.7]),r.shadowColor="rgba(0, 0, 0, 0.5)",r.filter="blur(3px)",core.strokeRect("door"+e+"_"+t,32*e,32*t-24,a,48,[255,255,255,.7],3)}}),20)}}function icyMomentem(){if(!(flags.haveIce||Math.random()<.5)){var e=Math.floor(100*Math.random()),t=[],r=0;flags.haveIce=!0,core.dymCanvas.icyMomentem?core.clearMap("icyMomentem"):core.createCanvas("icyMomentem",0,0,480,480,35);var o=window.setInterval((function(){var a,n,c=Math.floor(13*Math.random())+1,s=Math.floor(13*Math.random())+1;t.includes([c,s])||(t.push([c,s]),core.fillRect("icyMomentem",32*t[r][0]+2,32*t[r][1]+2,28,28,[150,150,255,.6])),r==e&&(clearInterval(o),a=0,n=window.setInterval((function(){var e=core.status.hero.loc.x,r=core.status.hero.loc.y;if(core.clearMap("icyMomentem",32*t[a][0],32*t[a][1],32,32),core.setBgFgBlock("bg",167,t[a][0],t[a][1]),core.drawAnimate("ice",t[a][0],t[a][1]),e==t[a][0]&&r==t[a][1]&&(core.drawHeroAnimate("hand"),core.status.hero.hp-=5e3,core.addPop(32*e+16,32*r+16,-5e3),core.updateStatusBar(),core.status.hero.hp<0))return core.status.hero.hp=0,core.updateStatusBar(),core.events.lose(),void clearInterval(n);a>=t.length-1&&(clearInterval(n),setTimeout((function(){!function(e){var t=0,r=window.setInterval((function(){core.setBgFgBlock("bg",0,e[t][0],e[t][1]),++t>=e.length&&(clearInterval(r),core.deleteCanvas("icyMomentem"),setTimeout((function(){delete flags.haveIce}),5e3))}),50)}(t)}),5e3)),a++}),50)),r++}),20)}}function startStage2(){core.createCanvas("flash",0,0,480,480,160);var e=0,t=0,r=window.setInterval((function(){core.clearMap("flash"),++t<=8?e+=.125:e-=.01,core.fillRect("flash",0,0,480,480,[255,255,255,e]),0==e&&(clearInterval(r),core.deleteCanvas("flash")),8==t&&(core.setWeather(),core.setWeather("rain",10),core.setWeather("fog",8),core.setCurtain([0,0,0,.3]),core.playBgm("towerBoss2.mp3"))}))}function randomThunder(){var e=Math.floor(13*Math.random())+1,t=Math.floor(13*Math.random())+1,r=Math.ceil(6*Math.random());core.dymCanvas.thunderDanger?core.clearMap("thunderDanger"):core.createCanvas("thunderDanger",0,0,480,480,35);for(var o=e-1;o<=e+1;o++)for(var a=t-1;a<=t+1;a++)core.fillRect("thunderDanger",32*o+2,32*a+2,28,28,[255,255,255,.6]);core.deleteCanvas("flash"),setTimeout((function(){core.playSound("thunder.mp3")}),500),setTimeout((function(){core.deleteCanvas("thunderDanger"),drawThunder(e,t,r)}),1e3)}function drawThunder(e,t,r){var o=getThunderRoute(32*e+16,32*t+16,r);core.dymCanvas.thunder?core.clearMap("thunder"):core.createCanvas("thunder",0,0,480,480,65);var a=core.dymCanvas.thunder;for(var n in a.shadowColor="rgba(220, 220, 255, 1)",a.shadowBlur=r,a.filter="blur(2.5px)",o)for(var c=0;c<o[n].length-1;c++){var s=o[n][c],l=o[n][c+1];core.drawLine("thunder",s[0],s[1],l[0],l[1],"#ffffff",2.5)}getThunderRoute(e,t,r);var i=0,u=.5;core.dymCanvas.flash?core.clearMap("flash"):core.createCanvas("flash",0,0,480,480,160);var d=window.setInterval((function(){u-=.05,i++,core.clearMap("flash"),core.fillRect("flash",0,0,480,480,[255,255,255,u]),i>=10&&(clearInterval(d),core.deleteCanvas("flash"),setTimeout((function(){core.deleteCanvas("thunder")}),700))}),20)}function getThunderRoute(e,t,r){for(var o=[],a=0;a<r;a++){var n=e,c=t;o[a]=[];for(var s=0;c>=0;s++)s>0?(n+=30*Math.random()-15,c-=80*Math.random()+30):(n+=16*Math.random()-8,c+=16*Math.random()-8),o[a].push([n,c])}return o}function ballThunder(){var e=Math.ceil(12*Math.random())+6,t=0,r=[],o=window.setInterval((function(){core.dymCanvas["ballThunder"+t]?core.clearMap("ballThunder"+t):core.createCanvas("ballThunder"+t,0,0,480,480,35);var a=Math.floor(13*Math.random())+1,n=Math.floor(13*Math.random())+1;if(!r.includes([a,n])){r.push([a,n]);for(var c=1;c<14;c++)core.fillRect("ballThunder"+t,32*c+2,32*n+2,28,28,[190,190,255,.6]);for(var s=1;s<14;s++)core.fillRect("ballThunder"+t,32*a+2,32*s+2,28,28,[190,190,255,.6])}++t>=e&&(clearInterval(o),setTimeout((function(){!function(e){var t=0;core.dymCanvas.ballAnimate?core.clearMap("ballAnimate"):core.createCanvas("ballAnimate",0,0,480,480,65);var r=core.dymCanvas.ballAnimate;r.shadowColor="rgba(255, 255, 255, 1)";var o=[],a=window.setInterval((function(){core.clearMap("ballAnimate");for(var n=0;n<e.length;n++)if(r.shadowBlur=16*Math.random(),t-10*n>0){var c=t-10*n;1==c&&core.playSound("electron.mp3");var s=32*e[n][0]+16,l=32*e[n][1]+16;if(c<=2?core.fillCircle("ballAnimate",s,l,16+3*c,[255,255,255,.9]):(core.fillCircle("ballAnimate",s,l-4*c,7+2*Math.random(),[255,255,255,.7]),core.fillCircle("ballAnimate",s,l+4*c,7+2*Math.random(),[255,255,255,.7]),core.fillCircle("ballAnimate",s-4*c,l,7+2*Math.random(),[255,255,255,.7]),core.fillCircle("ballAnimate",s+4*c,l,7+2*Math.random(),[255,255,255,.7])),core.clearMap("ballThunder"+n,s-16,l-16-4*c,32,32),core.clearMap("ballThunder"+n,s-16,l-16+4*c,32,32),core.clearMap("ballThunder"+n,s-16-4*c,l-16,32,32),core.clearMap("ballThunder"+n,s-16+4*c,l-16,32,32),!o[n]){var i=core.status.hero.loc.x,u=core.status.hero.loc.y;if(((Math.floor((s-16-4*c)/32)==i||Math.floor((s-16+4*c)/32)==i)&&e[n][1]==u||(Math.floor((l-16-4*c)/32)==u||Math.floor((l-16+4*c)/32)==u)&&e[n][0]==i)&&(o[n]=!0,core.status.hero.hp-=3e3,core.addPop(32*i+16,32*u+16,-3e3),core.updateStatusBar(),core.playSound("electron.mp3"),core.status.hero.hp<0))return core.status.hero.hp=0,core.updateStatusBar(),core.events.lose(),void clearInterval(a)}n==e.length-1&&c>120&&clearInterval(a)}t++}),20)}(r)}),1e3))}),200)}function startStage3(){core.createCanvas("flash",0,0,480,480,160);var e=0,t=0,r=window.setInterval((function(){core.clearMap("flash"),++t<=8?e+=.125:e-=.01,core.fillRect("flash",0,0,480,480,[255,255,255,e]),0==e&&(clearInterval(r),core.deleteCanvas("flash")),8==t&&(core.playSound("thunder.mp3"),function(){for(var e=0;e<15;e++)for(var t=0;t<15;t++)0!=e&&14!=e&&0!=t&&14!=t||core.removeBlock(e,t),1!=e&&13!=e&&1!=t&&13!=t||0==e||14==e||0==t||14==t||core.setBlock(527,e,t);core.createCanvas("tower7",0,0,480,480,15),core.drawImage("tower7","tower7.jpeg",360,0,32,480,0,0,32,480),core.drawImage("tower7","tower7.jpeg",840,0,32,480,448,0,32,480),core.drawImage("tower7","tower7.jpeg",392,0,416,32,32,0,416,32),core.drawImage("tower7","tower7.jpeg",392,448,416,32,32,448,416,32),core.setBlock("E557",7,2),core.playBgm("towerBoss3.mp3")}(),core.insertAction([{type:"changePos",loc:[7,7]}]))}))}function startStage4(){core.createCanvas("flash",0,0,480,480,160);var e=0,t=0,r=window.setInterval((function(){core.clearMap("flash"),++t<=8?e+=.125:e-=.01,core.fillRect("flash",0,0,480,480,[255,255,255,e]),0==e&&(clearInterval(r),core.deleteCanvas("flash")),8==t&&(core.playSound("thunder.mp3"),function(){for(var e=1;e<14;e++)for(var t=1;t<14;t++)1!=e&&13!=e&&1!=t&&13!=t||core.removeBlock(e,t),2!=e&&12!=e&&2!=t&&12!=t||1==e||13==e||1==t||13==t||core.setBlock(527,e,t);core.createCanvas("tower7",0,0,480,480,15),core.drawImage("tower7","tower7.jpeg",360,0,64,480,0,0,64,480),core.drawImage("tower7","tower7.jpeg",776,0,64,480,416,0,64,480),core.drawImage("tower7","tower7.jpeg",424,0,352,64,64,0,352,64),core.drawImage("tower7","tower7.jpeg",424,416,352,64,64,416,352,64),core.setBlock("E557",7,3)}(),core.insertAction([{type:"changePos",loc:[7,7]}]))}))}function startStage5(){core.createCanvas("flash",0,0,480,480,160);var e=0,t=0,r=window.setInterval((function(){core.clearMap("flash"),++t<=8?e+=.125:e-=.01,core.fillRect("flash",0,0,480,480,[255,255,255,e]),0==e&&(clearInterval(r),core.deleteCanvas("flash")),8==t&&(core.playSound("thunder.mp3"),function(){for(var e=2;e<13;e++)for(var t=2;t<13;t++)2!=e&&12!=e&&2!=t&&12!=t||core.removeBlock(e,t),3!=e&&11!=e&&3!=t&&11!=t||2==e||12==e||2==t||12==t||core.setBlock(527,e,t);core.createCanvas("tower7",0,0,480,480,15),core.drawImage("tower7","tower7.jpeg",360,0,96,480,0,0,96,480),core.drawImage("tower7","tower7.jpeg",744,0,96,480,384,0,96,480),core.drawImage("tower7","tower7.jpeg",456,0,288,96,96,0,288,96),core.drawImage("tower7","tower7.jpeg",456,384,288,96,96,384,288,96),core.setBlock("E557",7,4)}(),core.insertAction([{type:"changePos",loc:[7,7]}]))}))}function chainThunder(){var e=Math.ceil(6*Math.random())+3;core.dymCanvas.chainDanger?core.clearMap("chainDanger"):core.createCanvas("chainDanger",0,0,480,480,35);var t=[],r=0,o=window.setInterval((function(){if(hp>2e3)var a=Math.floor(11*Math.random())+2,n=Math.floor(11*Math.random())+2;else if(hp>1e3)a=Math.floor(9*Math.random())+3,n=Math.floor(9*Math.random())+3;else a=Math.floor(7*Math.random())+4,n=Math.floor(7*Math.random())+4;t.includes([a,n])||(t.push([a,n]),r>0&&core.drawLine("chainDanger",32*t[r-1][0]+16,32*t[r-1][1]+16,32*a+16,32*n+16,[220,100,255,.6],3),r>=e&&(clearInterval(o),setTimeout((function(){getChainRoute(t),core.deleteCanvas("chainDanger")}),1e3)),r++)}),100)}function chainAnimate(e){if(!e)return chainThunder();core.dymCanvas.chain?core.clearMap("chain"):core.createCanvas("chain",0,0,480,480,65);var t=core.dymCanvas.chain;t.shadowBlur=3,t.shadowColor="rgba(255, 255, 255, 1)",t.filter="blur(2px)";var r=0,o=0,a=window.setInterval((function(){if(o>=e.length-1)return clearInterval(a),void setTimeout((function(){core.deleteCanvas("chain")}),1e3);++r%2==0&&(core.drawLine("chain",e[o][0],e[o][1],e[o+1][0],e[o+1][1],"#ffffff",3),0==o&&core.fillCircle("chain",e[0][0],e[0][1],7,"#ffffff"),(e[o+1][0]-16)%32==0&&(e[o+1][1]-16)%32==0&&core.fillCircle("chain",e[o+1][0],e[o+1][1],7,"#ffffff"),lineDamage(e[o][0],e[o][1],e[o+1][0],e[o+1][1],4e3),o++)}),20)}function getChainRoute(e){var t=0,r=[],o=window.setInterval((function(){var a=32*e[t][0]+16,n=32*e[t][1]+16,c=32*e[t+1][0]+16,s=32*e[t+1][1]+16,l=c-a,i=s-n,u=Math.atan(i/l);i<0&&l<0&&(u+=Math.PI),l<0&&i>0&&(u+=Math.PI);for(var d=0;;){if(d++,a+=50*Math.random()*Math.cos(u),n+=50*Math.random()*Math.sin(u),r.push([a,n]),Math.sqrt(Math.pow(n-s,2)+Math.pow(a-c,2))<=100){r.push([c,s]);break}if(d>=20)return clearInterval(o),void(r=null)}++t>=e.length-1&&(clearInterval(o),chainAnimate(r))}),2)}function randomBoom(){var e,t;flags.booming?(hp>2e3?(e=500,t=11):hp>1e3?(e=400,t=9):(e=300,t=7),flags.boom=window.setInterval((function(){var e=Math.floor(Math.random()*t)+(15-t)/2,r=Math.floor(Math.random()*t)+(15-t)/2;boomLocs.push([e,r,0]),flags.booming||clearInterval(flags.boom)}),e),boomingAnimate()):clearInterval(flags.boom)}function boomingAnimate(){core.dymCanvas.boom?core.clearMap("boom"):core.createCanvas("boom",0,0,480,480,65);var e=window.setInterval((function(){0!=boomLocs.length&&(flags.booming||0!=boomLocs.length?(core.clearMap("boom"),boomLocs.forEach((function(t,r){t[2]++;var o=32*t[0]+16,a=32*t[1]+16;if(t[2]>=20)var n=1,c=12;else c=.12*Math.pow(20-t[2],2)+12,n=Math.max(1,2-.1*t[2]);var s=t[2]*Math.PI/50;if(core.fillCircle("boom",o,a,3,[255,50,50,n]),core.strokeCircle("boom",o,a,c,[255,50,50,n],2),core.drawLine("boom",o+c*Math.cos(s),a+c*Math.sin(s),o+(c+15)*Math.cos(s),a+(c+15)*Math.sin(s),[255,50,50,n],1),s+=Math.PI,core.drawLine("boom",o+c*Math.cos(s),a+c*Math.sin(s),o+(c+15)*Math.cos(s),a+(c+15)*Math.sin(s),[255,50,50,n],1),t[2]>70){var l=a-(20*(85-t[2])+2.8*Math.pow(85-t[2],2));core.drawImage("boom","boom.png",o-18,l-80,36,80)}if(85==t[2]){core.drawAnimate("explosion1",(o-16)/32,(a-16)/32),boomLocs.splice(r,1),0==boomLocs.length&&core.deleteCanvas("boom");var i=core.status.hero.loc.x,u=core.status.hero.loc.y;if(t[0]==i&&t[1]==u&&(core.status.hero.hp-=3e3,core.addPop(32*o+16,32*a+16,-3e3),core.updateStatusBar(),core.status.hero.hp<0))return core.status.hero.hp=0,core.updateStatusBar(),core.events.lose(),clearInterval(e),void(flags.booming=!1)}}))):clearInterval(e))}),20)}function lineDamage(e,t,r,o,a){var n=core.status.hero.loc.x,c=core.status.hero.loc.y;if(!(e<32*n-12&&r<32*n-12||e>32*n+12&&r>32*n+12||t<32*c-16&&o<32*c-16||t>32*c+16&&o>32*c+16))for(var s=1;s<=2;s++)if(1==s){var l=[32*n+12,32*c-16];if(((o-t)/(r-e)*((i=[32*n-12,32*c+16])[0]-e)+t-i[1])*((o-t)/(r-e)*(l[0]-e)+t-l[1])<=0)return core.status.hero.hp-=a,core.addPop(32*n+16,32*c+16,-a),core.updateStatusBar(),core.playSound("electron.mp3"),core.status.hero.hp<0?(core.status.hero.hp=0,core.updateStatusBar(),void core.events.lose()):void 0}else{var i;l=[32*n+12,32*c+16];if(((o-t)/(r-e)*((i=[32*n-12,32*c-16])[0]-e)+t-i[1])*((o-t)/(r-e)*(l[0]-e)+t-l[1])<=0)return core.status.hero.hp-=a,core.addPop(32*n+16,32*c+16,-a),core.updateStatusBar(),core.playSound("electron.mp3"),core.status.hero.hp<0?(core.status.hero.hp=0,core.updateStatusBar(),void core.events.lose()):void 0}}core.plugin.towerBoss={initTowerBoss:initTowerBoss};var towerBoss=Object.freeze({__proto__:null});function chaseInit1(){var e=[];["MT13","MT14","MT15"].forEach((function(t){core.status.maps[t].cannotMoveDirectly=!0,core.extractBlocks(t),core.status.maps[t].blocks.forEach((function(r){["animates","items"].includes(r.event.cls)&&!r.event.id.endsWith("Portal")&&e.push([r.x,r.y,t])}))})),e.forEach((function(e){var t;(t=core).removeBlock.apply(t,_toConsumableArray(e))}))}core.plugin.chase={chaseInit1:chaseInit1};var chase=Object.freeze({__proto__:null,chaseInit1:chaseInit1});class Range{collection;cache={};static rangeType={};constructor(e){this.collection=e}scan(e,t){const r=Range.rangeType[e];if(!r)throw new Error(`Unknown range type: ${e}.`);return r.scan(this,t)}inRange(e,t,r){const o=Range.rangeType[e];if(!o)throw new Error(`Unknown range type: ${e}.`);return o.inRange(this,t,r)}clearCache(){this.cache={}}static registerRangeType(e,t,r){Range.rangeType[e]={scan:t,inRange:r}}}Range.registerRangeType("square",((e,{x:t,y:r,d:o})=>{const a=e.cache.square??={},n=`${t},${r},${o}`;if(n in a)return a[n];const c=e.collection.list,s=Math.floor(o);return a[n]=c.filter((e=>core.has(e.x)&&core.has(e.y)&&Math.abs(e.x-t)<=s&&Math.abs(e.y-r)<=s))}),((e,{x:t,y:r,d:o},a)=>{const n=Math.floor(o/2);return core.has(a.x)&&core.has(a.y)&&Math.abs(a.x-t)<=n&&Math.abs(a.y-r)<=n}));const haloSpecials=[21,25,26,27];class EnemyCollection{floorId;list=[];range=new Range(this);mapDamage={};haloList=[];constructor(e){this.floorId=e}extract(){core.extractBlocks(this.floorId),core.status.maps[this.floorId].blocks.forEach((e=>{if("enemy48"!==e.event.cls&&"enemys"!==e.event.cls)return;const t=core.material.enemys[e.event.id];this.list.push(new DamageEnemy(t,e.x,e.y,this.floorId,this))}))}calRealAttribute(e=!1){this.list.forEach((t=>{e&&t.reset(),t.calRealAttribute()}))}calDamage(e=!1){this.list.forEach((t=>{(e||t.needCalculate)&&(t.reset(),t.calRealAttribute()),t.calDamage()}))}calMapDamage(e=!1){e&&(this.mapDamage={}),this.list.forEach((e=>{e.calMapDamage(this.mapDamage)}))}applyHalo(e,t,r,o=!1){const a=ensureArray(r),n=this.range.scan(e,t);o?n.forEach((e=>{a.forEach((t=>{e.injectHalo(t),e.preProvideHalo()}))})):a.forEach((e=>{n.forEach((t=>{t.injectHalo(e)}))}))}preBalanceHalo(){this.list.forEach((e=>{e.preProvideHalo()}))}}class DamageEnemy{id;x;y;floorId;enemy;col;info;needCalculate=!0;damage;needCalDamage=!0;providedHalo=[];constructor(e,t,r,o,a){this.id=e.id,this.enemy=e,this.x=t,this.y=r,this.floorId=o,this.col=a,this.reset()}reset(){const e=this.enemy;this.info={hp:e.hp,atk:e.atk,def:e.def,special:e.special.slice(),damageDecline:0,atkBuff:0,defBuff:0,hpBuff:0,together:0,enemy:this.enemy},this.needCalculate=!0,this.needCalDamage=!0}calAttribute(e=core.status.hero,t=!0){if(!this.needCalculate)return;const r=this.info.special,o=this.info,a=this.enemy,n=this.floorId??core.status.floorId,{atk:c}=t?getHeroStatusOf(e,["atk"],e.x,e.y,e.floorId):e;if(has(c)&&(r.includes(7)&&(o.atk+=c*(a.hungry??0)/100),2===flags.hard&&r.includes(14)&&(o.atk+=flags[`inte_${n}`]??0),o.atk-=flags[`night_${n}`]??0,o.def-=flags[`night_${n}`]??0,r.includes(3)&&a.def<c-1&&(o.def=c-1),has(flags[`melt_${n}`])&&has(this.x)&&has(this.y)))for(const[e,t]of Object.entries(flags[`melt_${n}`])){const[r,a]=e.split(",").map((e=>parseInt(e)));Math.abs(r-this.x)<=1&&Math.abs(a-this.y)<=1&&(o.atkBuff+=t,o.defBuff+=t)}}getRealInfo(){if(!this.needCalculate)return this.info;const e=this.info;return e.atk*=e.atkBuff/100+1,e.def*=e.defBuff/100+1,e.hp*=e.hpBuff/100+1,this.needCalculate=!1,this.info}calRealAttribute(){this.preProvideHalo(),this.calAttribute(),this.provideHalo(),this.getRealInfo()}getHaloSpecials(){if(!this.floorId)return[];if(!core.has(this.x)||!core.has(this.y))return[];const e=(this.info.special??this.enemy.special).filter((e=>haloSpecials.includes(e)&&!this.providedHalo.includes(e)));if(0===e.length)return[];if(!(this.col??core.status.maps[this.floorId].enemy))throw new Error(`Unexpected undefined of enemy collection in floor ${this.floorId}.`);return e}preProvideHalo(){}provideHalo(){if(!this.floorId)return;if(!core.has(this.x)||!core.has(this.y))return;const e=this.col??core.status.maps[this.floorId].enemy;if(!e)return;const t=this.getHaloSpecials(),r=[],o=[];t.includes(8)&&(o.push(((e,t)=>{e===this.info&&(e.together+=t.together??0)})),this.providedHalo.push(8)),t.includes(21)&&(r.push(((e,t)=>{e.damageDecline+=t.iceDecline??0})),this.providedHalo.push(21)),t.includes(26)&&(o.push(((e,t)=>{e.defBuff+=t.iceCore??0})),this.providedHalo.push(26)),t.includes(27)&&(o.push(((e,t)=>{e.atkBuff+=t.fireCore??0})),this.providedHalo.push(27)),e.applyHalo("square",{x:this.x,y:this.y,d:7},r),e.applyHalo("square",{x:this.x,y:this.y,d:5},o)}injectHalo(e){e.call(this,this.info,this.enemy)}calDamage(e=core.status.hero){if(!this.needCalDamage)return this.damage;const t=this.getRealInfo(),r=getNeedCalDir(this.x,this.y,this.floorId,e),o={};return this.needCalDamage=!1,this.damage=r.map((r=>{const a=getHeroStatusOf(e,realStatus);let n,c,s=calDamageWith(t,a)??1/0,l=-1;if(flags.autoSkill)for(let r=0;r<skills.length;r++){const[a,n]=skills[r];if(!flags[a])continue;flags[n]=!0;const c=getHeroStatusOf(e,realStatus),i=`${c.atk},${c.def}`,u=i in o?o[i]:calDamageWith(t,c)??1/0;u<s&&(s=u,l=r),flags[n]=!1,o[i]=u}return has(this.x)&&has(this.y)&&("none"!==r?[n,c]=ofDir(this.x,this.y,r):(n=e.x??this.x,c=e.y??this.y)),{damage:s,dir:r,skill:l,x:n,y:c}}))}calMapDamage(e){return e??={},e}}const realStatus=["atk","def"],skills=[["bladeOn","blade"],["shieldOn","shield"]];function getNeedCalDir(e,t,r=core.status.floorId,o=core.status.hero){if(flags.chapter<2||!has(e)||!has(t))return["none"];if(has(o.x)&&has(o.y))return["none"];const{width:a,height:n}=core.status.maps[r],c=core.getMapBlocksObj(r),s=["left","down","right","up"].filter((o=>{const[s,l]=ofDir(e,t,o);if(s<0||l<0||s>=a||l>=n)return!1;return!c[`${s},${l}`].event.noPass&&!!core.canMoveHero(s,l,backDir(o),r)}));return 0===s.length?["none"]:s}function calDamageWith(e,t){const{hp:r,hpmax:o,mana:a,mdef:n}=core.status.hero;let{atk:c,def:s}=t;const{hp:l,atk:i,def:u,special:d,enemy:f}=e;let p,h,m=0;if(d.includes(7)&&(c*=1-f.hungry/100),d.includes(9)){if(p=c+a-u,p<=0)return null}else{if(p=c-u,!(p>0))return null;p+=a}d.includes(2)||d.includes(13)?h=i:(h=i-s,h<0&&(h=0)),d.includes(4)&&(h*=2),d.includes(5)&&(h*=3),d.includes(6)&&(h*=f.n),d.includes(20)&&!core.hasEquip("I589")&&(p*=1-f.ice/100),p*=1-e.damageDecline;let g=Math.ceil(l/p);if(d.includes(1)){m+=Math.floor(g/5)*(f.crit-100)/100*h}return g>1&&d.includes(10)&&(m+=(f.courage/100-1)*h),d.includes(11)&&(m+=f.charge/100*h,g+=5),m+=(g-1)*h,flags.superSheild&&(m-=n/10),m-=o*g,1===flags.hard&&(m*=.9),m}core.plugin.damage={Enemy:DamageEnemy,Collection:EnemyCollection};var damage=Object.freeze({__proto__:null,DamageEnemy:DamageEnemy,EnemyCollection:EnemyCollection,calDamageWith:calDamageWith,getNeedCalDir:getNeedCalDir,haloSpecials:haloSpecials});return exports.chase=chase,exports.damage=damage,exports.halo=halo,exports.hero=hero,exports.loopMap=loopMap,exports.remainEnemy=remainEnemy,exports.removeMap=removeMap,exports.shop=shop,exports.skill=skills$2,exports.skillTree=skillTree,exports.study=study,exports.towerBoss=towerBoss,exports.utils=utils,exports}({});
